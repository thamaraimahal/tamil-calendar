<!doctype html>
<html lang="ta">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Pon Thamarai Mahal — Events Calendar</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root {
    --accent:#6a2c91;
    --booked:#d9534f;
    --available:#2e7d32;
    --disabled:#bdbdbd;
  }

  body {
    margin:0; padding:10px;
    font-family:Nunito,sans-serif; background:#fff; color:#222;
  }

  .header { text-align:center; margin-bottom:10px; }
  .eng-month { font-size:18px; font-weight:700; color:var(--accent); }
  .nav { margin-top:6px; }

  .btn {
    font-size:13px; padding:4px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    background:#fff;
    cursor:pointer;
    margin:0 4px;
  }

  .btn:hover { background:#f8f8f8; }

  /* Weekday labels */
  .weekdays {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    text-align:center;
    font-size:12px;
    font-weight:600;
    color:#555;
    margin-bottom:6px;
  }

  /* Calendar */
  .calendar-grid {
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    gap:6px;
  }

  .day-cell {
    border:1px solid #eee;
    border-radius:8px;
    padding:6px;
    background:#fff;
    display:flex;
    flex-direction:column;
    min-height:70px;
    box-shadow:0 1px 2px rgba(0,0,0,0.05);
  }

  .eng-daynum { font-size:14px; font-weight:700; }
  .tamil-date { font-family:'Noto Sans Tamil'; font-size:12px; margin-top:2px; }

  .status-pill {
    margin-top:auto;
    font-size:11px;
    padding:2px 6px;
    border-radius:4px;
    color:#fff;
  }

  .booked { background:var(--booked); }
  .available { background:var(--available); }
  .disabled { background:var(--disabled); }

  /* MOBILE FIXES */
  @media (max-width:600px){
    .calendar-grid { gap:3px; }
    .day-cell { min-height:55px; padding:4px; }
    .eng-daynum { font-size:11px; }
    .tamil-date { font-size:10px; }
    .status-pill { font-size:8px; padding:1px 3px; }
    .eng-month { font-size:15px; }
    .btn { font-size:11px; padding:3px 8px; }
  }
</style>
</head>

<body>

<div class="header">
  <div id="engMonth" class="eng-month">—</div>
  <div class="nav">
    <button id="prevBtn" class="btn">◀ Prev</button>
    <button id="nextBtn" class="btn">Next ▶</button>
  </div>
</div>

<div class="weekdays">
  <div>Sun</div><div>Mon</div><div>Tue</div>
  <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
</div>

<div id="calendarGrid" class="calendar-grid"></div>

<script>
/* ------------------------
   CONFIG
-------------------------*/
const ICS_URL =
  'https://api.allorigins.win/raw?url=' +
  encodeURIComponent('https://calendar.zoho.in/ical/zz08021230c4742127d24c58a9f35a59c4a3d8350113a19df6ef5d6de7971ecad8a2f106d528472555dedf1f5217caa660216a85f3');

const CONTACT_URL =
  'https://thamarayaal.wixsite.com/pon-thamarai-mahal#get-in-touch';

/* Tamil month sequence */
const TAMIL_MONTHS = [
  'சித்திரை','வைகாசி','ஆனி','ஆடி','ஆவணி','புரட்டாசி',
  'ஐப்பசி','கார்த்திகை','மார்கழி','தை','மாசி','பங்குனி'
];

const monthLengths = [31,31,31,31,31,31,30,30,30,29,30,30];

const today = new Date();
let viewYear = today.getFullYear();
let viewMonth = today.getMonth();

/* ------------------------
    ICS FETCH
-------------------------*/
async function fetchICS(){
  try {
    const res = await fetch(ICS_URL);
    return res.ok ? await res.text() : '';
  } catch {
    return '';
  }
}

function parseICS(text){
  const booked = new Set();
  for (const line of text.split(/\r?\n/)){
    if(line.startsWith('DTSTART')){
      const raw = line.split(':')[1];
      if(!raw) continue;
      const d = raw.slice(0,8);
      booked.add(d.slice(0,4)+'-'+d.slice(4,6)+'-'+d.slice(6,8));
    }
  }
  return booked;
}

function dateKey(d){
  return d.toISOString().split('T')[0];
}

/* ------------------------
   SUNRISE-BASED TAMIL DATE
-------------------------*/
function getTamilDate(y, m, d){
  // Always use 6 AM timestamp to avoid midnight shift problems
  const date = new Date(y, m, d, 6, 0);

  // Reference: Tamil Chithirai 1, 2024 = April 14, 2024, 6 AM
  const ref = new Date(2024, 3, 14, 6, 0);

  let diff = Math.floor((date - ref) / 86400000);
  if(diff < 0) diff = (diff % 365 + 365) % 365;

  let idx = 0;
  let remain = diff;

  while(remain >= monthLengths[idx]){
    remain -= monthLengths[idx];
    idx = (idx + 1) % 12;
  }

  return {
    tamilMonth: TAMIL_MONTHS[idx],
    tamilDate: remain + 1
  };
}

/* ------------------------
   CALENDAR RENDERING
-------------------------*/
function buildCalendar(booked){
  const grid = document.getElementById('calendarGrid');
  const engEl = document.getElementById('engMonth');

  engEl.textContent = new Date(viewYear, viewMonth)
    .toLocaleString('en-US',{month:'long', year:'numeric'});

  grid.innerHTML = '';

  const first = new Date(viewYear, viewMonth, 1);
  const days = new Date(viewYear, viewMonth+1, 0).getDate();
  const start = first.getDay();

  for(let i=0;i<start;i++){
    const empty = document.createElement('div');
    empty.className = 'day-cell';
    empty.style.visibility = 'hidden';
    grid.appendChild(empty);
  }

  for(let d=1; d<=days; d++){
    const current = new Date(viewYear, viewMonth, d);
    const key = dateKey(current);

    const cell = document.createElement('div');
    cell.className = 'day-cell';

    const eng = document.createElement('div');
    eng.className = 'eng-daynum';
    eng.textContent = d;

    // Correct Tamil date
    const t = getTamilDate(viewYear, viewMonth, d);

    const tamil = document.createElement('div');
    tamil.className = 'tamil-date';
    tamil.textContent = `${t.tamilMonth} ${t.tamilDate}`;

    const pill = document.createElement('div');
    pill.className = 'status-pill';

    if(key < dateKey(today)){
      pill.classList.add('disabled');
      pill.textContent = 'Past';
    }
    else if(booked.has(key)){
      pill.classList.add('booked');
      pill.textContent = 'Booked';
    }
    else {
  pill.classList.add('available');
  pill.textContent = 'Available';
  cell.style.cursor = 'pointer';

  cell.onclick = () => {
    // Format clicked date as YYYY-MM-DD
    const selectedDate = key;

    // Send to parent (Wix page)
    window.parent.postMessage(
      {
        calendarDate: selectedDate,
      },
      "*"
    );
  };
}

    cell.appendChild(eng);
    cell.appendChild(tamil);
    cell.appendChild(pill);
    grid.appendChild(cell);
  }
}

/* ------------------------
   INIT
-------------------------*/
(async ()=>{
  const ics = await fetchICS();
  const booked = parseICS(ics);

  buildCalendar(booked);

  document.getElementById('prevBtn').onclick = () => {
    viewMonth--;
    if(viewMonth < 0){ viewMonth = 11; viewYear--; }
    buildCalendar(booked);
  };

  document.getElementById('nextBtn').onclick = () => {
    viewMonth++;
    if(viewMonth > 11){ viewMonth = 0; viewYear++; }
    buildCalendar(booked);
  };
})();
</script>

</body>
</html>
